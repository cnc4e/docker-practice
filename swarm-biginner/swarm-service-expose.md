[TOP](../README.md)   
前: [サービスのボリュームマウント](./swarm-service-volume.md)  
次: [サービスのヘルスチェック](./swarm-service-healthcheck.md)  

---

# サービスの外部公開

コンテナに外部からアクセスするにはコンテナとホストポートをマッピングします。

1. 以下満たすcomposeファイル`service-expose.yaml`を作成してください。（[ヒント](https://docs.docker.com/compose/compose-file/compose-file-v3/#ports)）

- service名: test
- image: nginx
- replicas: 1
- port: ホストの8000をコンテナの80にマッピング（Long syntaxで設定する場合モードはingress）

2. 上記作成したcomposeファイルを指定し、スタック`test`を作成してください。

3. スタックの一覧、スタック内のサービス一覧、スタック内のタスク一覧をそれぞれ表示し、タスクが1つデプロイされていることを確認してください。また、サービスが`*:8000->80/tcp`のように外部公開できていることを確認してください。タスクがスケジュールされたノード名も確認してください。

4. ワーカーノードにつながる端末からcurlやブラウザなどを使用し`<タスクを実行しているワーカーノードIP or ホスト名>:8000`に接続してください。`Welcome to nginx!`が表示されることを確認してください。（もし接続できない場合、AWSの場合SecurityGroupで端末から8000へのインバウンドが許可されていることを確認してください。）

5. ワーカーノードにつながる端末からcurlやブラウザなどを使用し`<タスクを実行していないワーカーノードIP or ホスト名>:8000`に接続してください。`Welcome to nginx!`が表示されることを確認してください。（もし接続できない場合、AWSの場合SecurityGroupで端末から8000へのインバウンドが許可されていることを確認してください。）

6. マネージャノードにつながる端末からcurlやブラウザなどを使用しいずれかの`<マネージャノードIP or ホスト名>:8000`に接続してください。`Welcome to nginx!`が表示されることを確認してください。（もし接続できない場合、AWSの場合SecurityGroupで端末から8000へのインバウンドが許可されていることを確認してください。）

7. サービス`test`のレプリカ数を2に増やしてください。

8. 各タスクを実行しているワーカーノードに接続し、サービス`test`でデプロイされたコンテナの`/usr/share/nginx/html/index.html`の内容を以下のようにワーカーノードの名前などコンテナごとに一意となる内容に修正してください。

``` sh
docker exec -it <container id> sh
echo <worker0 or 1> > /usr/share/nginx/html/index.html
```

9.  ワーカーノードにつながる端末からcurlやブラウザなどを使用し`<ワーカーノードIP or ホスト名>:8000`に複数回接続してください。結果が`worker0`と`worker1`のようにランダムで表示されることを確認してください。（もし接続できない場合、AWSの場合SecurityGroupで端末から8000へのインバウンドが許可されていることを確認してください。）

10. 同じcomposeファイルを指定し、スタッタ`test2`を作成してください。ポート8000がバッティングして作成に失敗することを確認してください。

11. スタック`test`、`test2`を削除してください。

このようにポートをマッピングしてコンテナを外部に公開できます。外部公開に使用するホストポートはクラスタ内のすべてのノードで使用されます。そのため同じクラスタで同じホストポートを使った外部公開はできません。また、外部からの通信はクラスタ内に構成されたルーティングメッシュを経由してコンテナに接続します。そのため、たとえアクセス先として指定したワーカーノード上でタスクが実行されていも別のワーカーノード上のタスクにルーティングされる可能性があります。[ネタ元](https://docs.docker.com/network/overlay/#bypass-the-routing-mesh-for-a-swarm-service)

このプラクティスの解答例は[こちら](./.ans/swarm-service-expose.md)

---

[TOP](../README.md)   
前: [サービスのボリュームマウント](./swarm-service-volume.md)  
次: [サービスのヘルスチェック](./swarm-service-healthcheck.md)  