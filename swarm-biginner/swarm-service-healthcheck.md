[TOP](../README.md)   
前: [サービスの外部公開](./swarm-service-expose.md)  
次: [サービスの環境変数](./swarm-service-env.md)  

---

# サービスのヘルスチェック

コンテナのメインプロセスが落ちてしまった場合、デフォルトではコンテナを自動で再作成してくれます。しかし、たとえばプロセスハングなど、プロセスが残っているが正常な動作をしていない場合は再作成してくれません。サービスのヘルスチェックを設定するとそのような場合でもコンテナを再作成してくれるようになります。

まずはヘルスチェックを設定しない場合の動作を確認します。

1. 以下を満たすcomposeファイル`service-healthcheck.yaml`を作成してください。

- service名: test
- image: nginx
- replicas: 2　(worker0にタスクを配置したいだけなので別のやりかたでもOK)

2. 上記作成したcomposeファイルを指定し、スタック`test`を作成してください。

3. スタックの一覧、スタック内のサービス一覧、スタック内のタスク一覧をそれぞれ表示し、タスクが2つデプロイされていることを確認してください。また、タスクがworker0にスケジュールされていることを確認してください。

4. **worker0**にてコンテナの一覧を表示してください。コンテナのIDを確認してください。

5. **worker0**にて以下コマンドでコンテナに追加コマンドを発行してください。`Welcome to nginx!`が表示されることを確認してください。

``` sh
docker exec <コンテナID> curl -s localhost
```

6. **worker0**にて以下コマンドを実行しコンテナで実行しているnginxのPIDを確認してください。（3つくらいあるはずです。）

``` sh
ps -ef | grep -e nginx | grep -v grep
```

7. **worker0**にて以下コマンドを実行し先ほど確認したnginxのプロセスをすべて一時停止してください。

``` sh
kill -stop <pid> <pid> <pid>
```

8. **worker0**にてコンテナの一覧を表示してください。さきほどのコンテナIDと同じものが表示されることを確認してください。

9. **worker0**にて以下コマンドでコンテナに追加コマンドを発行してください。応答が返ってこないことを確認してください。確認したらCtl + cなどで終了してください。

``` sh
docker exec <コンテナID> curl -s localhost
```

このようにプロセスがハングしてもコンテナは再作成されません。これだとコンテナがあっても正しくサービスを提供できているかわかりません。続いて、healthcheckを設定して改善します。

10. composeファイル`service-healthcheck.yaml`を以下満たすように修正してください。（[ヒント](https://docs.docker.com/compose/compose-file/compose-file-v3/#healthcheck)）

- service名: test
- image: nginx
- replicas: 2　(worker0にタスクを配置したいだけなので別のやりかたでもOK)
- healthcheck: コマンドは`curl localhost`、間隔は5秒、タイムアウト1秒、試行回数3回、開始時間30秒

11. 上記作成したcomposeファイルを指定し、スタック`test`を更新してください。

12. スタックの一覧、スタック内のサービス一覧、スタック内のタスク一覧をそれぞれ表示し、タスクが2つデプロイされていることを確認してください。また、タスクがすべて新しく入れ替わっていることを確認してください。

13. **worker0**にてコンテナの一覧を表示してください。コンテナのIDを確認してください。また、コンテナのステータスに`healthy`が追加されていることを確認してください。

14. **worker0**にて以下コマンドでコンテナに追加コマンドを発行してください。`Welcome to nginx!`が表示されることを確認してください。

``` sh
docker exec <コンテナID> curl -s localhost
```

15. **worker0**にて以下コマンドを実行しコンテナで実行しているnginxのPIDを確認してください。（3つくらいあるはずです。）

``` sh
ps -ef | grep -e nginx | grep -v grep
```

16. **worker0**にて以下コマンドを実行し先ほど確認したnginxのプロセスをすべて一時停止してください。その後すぐにwatchコマンドも実行してください。

``` sh
kill -stop <pid> <pid> <pid>
watch docker ps
```

17. **worker0**にてコンテナの状態が変わっていくことを確認してください。まずステータスが`unhealthy`となり、さらにしばらくするとコンテナが削除され新しいIDのコンテナが作成されます。新しいコンテナのステータスが`healthy`になったらctl + cなどでwatchを終了してください。

18. **worker0**にて以下コマンドでコンテナに追加コマンドを発行してください。`Welcome to nginx!`が表示されることを確認してください。

``` sh
docker exec <コンテナID> curl -s localhost
```

19. スタック`test`を削除してください。

このようにhealthcheckを設定するとサービスの異常を検知してコンテナを再作成してくれます。なお、dockerのヘルスチェックはコマンドの実行結果でしか判別できない点に注意してください。たとえば、ヘルスチェックでhttpレスポンスの200or300以外を受け取ったとしてもcurlコマンドの実行結果は0になります。なのでhttpレスポンスのステータスのように単純なコマンド実行結果で判別できないようなヘルスチェックを実装したい場合は作り込みが必要です。

---

[TOP](../README.md)   
前: [サービスの外部公開](./swarm-service-expose.md)  
次: [サービスの環境変数](./swarm-service-env.md)  