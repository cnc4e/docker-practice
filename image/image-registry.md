[TOP](../README.md)   
前: [イメージの取得/削除](./image-operation.md)  
次: [イメージの作成](./image-build.md)  

---

# イメージレジストリ

コンテナイメージを保管・共有するイメージレジストリはいくつかあります。大きく、パブリックとプライベートに分けられます。パブリックのイメージレジストリとしてはDocker公式の[Docker Hub](https://hub.docker.com/)が有名です。プライベートのイメージレジストリはさらにマネージド・サービスとスクラッチを選択できます。マネージド・サービスとしてはAWSの[ECR](https://aws.amazon.com/jp/ecr/)、Azureの[ACR](https://azure.microsoft.com/ja-jp/services/container-registry/)などがあります。スクラッチは自分でローカル環境に構築するレジストリで[Dockerレジストリ](http://docs.docker.jp/registry/index.html)が有名です。

以下の手順ではプライベートレジストリとして``Dockerレジストリ``を動かします。Dockerレジストリ自体もコンテナイメージで提供されているため、コンテナを実行すればすぐに使うことができます。

1. ``registry:2.7.1``のイメージを使いコンテナをバックグラウンドで実行してください。また、ホストOSの``5000``ポートをコンテナの``5000``ポートに繋いでください。

以上でホストOS上にプライベートなイメージレジストリができます。なお、レジストリのイメージデータは永続化が必要です。そのため、もしDockerレジストリを使う場合は``/var/lib/registry``をボリュームマウントなどで永続化しましょう。また、AWSやAzueeなどのクラウド環境ではマネージド・サービスを利用した方が良いでしょう。

次に、プライベートなイメージレジストリにイメージを保存してみます。

2. ホストOS内にダウンロード済みのコンテナイメージを確認してください。

3. 適当なコンテナイメージ1つを選択し、``{ホストOSのホスト名}:5000/testimage:v1``というイメージ名にタグをつけ直してください。（ヒント：イメージ名の操作は[docker tag](https://docs.docker.jp/engine/reference/commandline/tag.html)コマンドを使います。）

4. ホストOS内にダウンロード済みのコンテナイメージを確認してください。REPOSITORY:``{ホストOSのホスト名}:5000/testimage``、TAG:``v1``のイメージがあることを確認してください。

なお、イメージレジストリにイメージを保存（push）する前にレジストリへログインするか、レジストリを安全なレジストリとして登録します。今回はプライベートのレジストリであるため、安全なレジストリとして登録します。

5. 以下のように``/etc/docker/daemon.json``を作成します。（権限で書き込めない場合はviなどで作成してください。）
   ``` sh
   echo {"insecure-registries": ["{ホストOSのホスト名}:5000"]} > /etc/docker/daemon.json
   ```

6. dockerを再起動します。
   ``` sh
   sudo systemctl restart docker
   ```

これでホストOS上のレジストリを安全なレジストリとして登録できます。あとはpushすればレジストリにイメージが保存されます。なお、daemonの設定は安全なレジストリの追加以外にもさまざまな設定項目があります。設定できる内容については次の[日本語マニュアル](http://docs.docker.jp/engine/reference/commandline/daemon.html)をご確認ください。

7. イメージ``{ホストOSのホスト名}:5000/testimage:v1``をイメージレジストリに保存してください。（ヒント：イメージのリモートへの保存は[docker push](https://docs.docker.jp/engine/reference/commandline/push.html)コマンドを使います。）

8. プライベートレジストリにイメージが格納できたか確認します。以下のcurlコマンドをホストOSで実行してください。``testimage``が表示されるはずです。
   ``` sh
   curl localhost:5000/v2/_catalog
   ```

このようにイメージをイメージレジストリに格納できます。気づいたと思いますが、イメージ名には格納するレジストリ名を含めます。レジストリ名を名前解決可能なホスト名にすれば、ホストOS外からもプライベートレジストリに対してpush/pullできます。

9. dockerがインストール済みでホストOSに接続可能な別マシンから以下コマンド実行してください。
   ``` sh
   docker pull {ホストOSのホスト名}:5000/testimage:v1
   ```
10. 別マシンのローカルにあるイメージの一覧を表示してください。``{ホストOSのホスト名}:5000/testimage:v1``があることを確認してください。

11. 以下コマンドでホストOSのコンテナを削除してください。
    ``` sh
    docker rm -f `docker ps -a -q`
    ```

イメージレジストリがあるとイメージの共有が簡単に行えます。今回はプライベートなレジストリを使用しましたがDocker Hubなどでも同様にイメージを管理できます。ただし、認証が有効化されいてるレジストリに対しては``docker login``による認証が必要な場合もあるためレジストリの仕様を確認ください。

また、イメージレジストリがなくともイメージを手で配布することもできなくはないです。やり方は[イメージの手動運搬](./image-transport.md)で解説していますので興味のある方は見てください。

---

[TOP](../README.md)   
前: [イメージの取得/削除](./image-operation.md)  
次: [イメージの作成](./image-build.md)  
